<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>同步管理</title>
    <th:block layout:fragment="head">
        <style>
            .status-card {
                border: none;
                border-radius: 12px;
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
                transition: transform 0.2s;
            }
            .status-card:hover {
                transform: translateY(-2px);
            }
            .status-card .card-body {
                padding: 1.5rem;
            }
            .status-icon {
                width: 48px;
                height: 48px;
                border-radius: 12px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
            }
            .status-value {
                font-size: 1.75rem;
                font-weight: 700;
                margin-bottom: 0;
            }
            .status-label {
                color: #6c757d;
                font-size: 0.875rem;
                margin-bottom: 0;
            }
            .sync-btn {
                padding: 12px 32px;
                font-size: 1.1rem;
                font-weight: 600;
                border-radius: 10px;
                transition: all 0.3s;
            }
            .sync-btn:disabled {
                opacity: 0.7;
            }
            .sync-progress {
                display: none;
            }
            .sync-progress.active {
                display: block;
            }
            .log-table th {
                font-weight: 600;
                color: #495057;
                border-bottom: 2px solid #dee2e6;
            }
            .badge-status {
                padding: 6px 12px;
                border-radius: 6px;
                font-weight: 500;
            }
            .pulse {
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0% { opacity: 1; }
                50% { opacity: 0.5; }
                100% { opacity: 1; }
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content">
    <!-- 页面标题 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1" style="font-weight: 700;">
                <i class="bi bi-arrow-repeat"></i> 同步管理
            </h2>
            <p class="text-muted mb-0">管理 GitHub Star 数据同步</p>
        </div>
        <button class="btn btn-primary sync-btn" id="btnSync" onclick="startSync()">
            <i class="bi bi-arrow-clockwise"></i> 立即同步
        </button>
    </div>

    <!-- 同步进度提示 -->
    <div class="alert alert-info sync-progress mb-4" id="syncProgress" role="alert">
        <div class="d-flex align-items-center">
            <div class="spinner-border spinner-border-sm me-2" role="status">
                <span class="visually-hidden">同步中...</span>
            </div>
            <span id="syncProgressText" class="pulse">正在同步数据，请稍候...</span>
        </div>
    </div>

    <!-- 状态卡片 -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card status-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="status-icon bg-primary bg-opacity-10 text-primary me-3">
                            <i class="bi bi-database"></i>
                        </div>
                        <div>
                            <p class="status-value" id="totalRepos" th:text="${syncStatus['totalRepos'] ?: 0}">0</p>
                            <p class="status-label">仓库总数</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card status-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="status-icon bg-success bg-opacity-10 text-success me-3">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div>
                            <p class="status-value" id="lastSyncCount" th:text="${syncStatus['lastSyncCount'] ?: '-'}">-</p>
                            <p class="status-label">上次同步数</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card status-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="status-icon bg-info bg-opacity-10 text-info me-3">
                            <i class="bi bi-clock-history"></i>
                        </div>
                        <div>
                            <p class="status-value" style="font-size: 1rem;" id="lastSyncTime"
                               th:text="${syncStatus['lastSuccessTime'] ?: '从未同步'}">从未同步</p>
                            <p class="status-label">上次同步时间</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card status-card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="status-icon bg-warning bg-opacity-10 text-warning me-3">
                            <i class="bi bi-activity"></i>
                        </div>
                        <div>
                            <p class="status-value" style="font-size: 1rem;" id="currentStatus"
                               th:text="${syncStatus['status'] ?: '空闲'}">空闲</p>
                            <p class="status-label">当前状态</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 同步日志 -->
    <div class="card" style="border: none; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08);">
        <div class="card-header bg-white border-0 pt-4 pb-0 px-4">
            <h5 class="card-title mb-0" style="font-weight: 700;">
                <i class="bi bi-journal-text"></i> 同步日志
            </h5>
        </div>
        <div class="card-body px-4">
            <div class="table-responsive">
                <table class="table table-hover log-table">
                    <thead>
                    <tr>
                        <th>类型</th>
                        <th>状态</th>
                        <th>总数</th>
                        <th>同步数</th>
                        <th>开始时间</th>
                        <th>完成时间</th>
                        <th>错误信息</th>
                    </tr>
                    </thead>
                    <tbody id="logTableBody">
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">加载中...</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <!-- 分页 -->
            <nav id="logPagination" class="d-flex justify-content-center">
                <ul class="pagination" id="paginationUl">
                </ul>
            </nav>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script>
        // 当前页码
        var currentPage = 1;
        var pageSize = 10;
        var pollingTimer = null;

        // 页面加载后初始化
        document.addEventListener('DOMContentLoaded', function () {
            // 高亮导航
            document.getElementById('nav-sync').classList.add('active');
            // 加载日志
            loadLogs(1);
            // 检查同步状态
            checkStatus();
        });

        // 开始同步
        function startSync() {
            var btn = document.getElementById('btnSync');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> 同步中...';

            fetch('/sync/manual', {method: 'POST'})
                .then(function (res) { return res.json(); })
                .then(function (data) {
                    if (data.success) {
                        document.getElementById('syncProgress').classList.add('active');
                        startPolling();
                    } else {
                        alert(data.message);
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 立即同步';
                    }
                })
                .catch(function (err) {
                    alert('请求失败: ' + err.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 立即同步';
                });
        }

        // 开始轮询同步状态
        function startPolling() {
            if (pollingTimer) clearInterval(pollingTimer);
            pollingTimer = setInterval(function () {
                checkStatus();
            }, 2000);
        }

        // 检查同步状态
        function checkStatus() {
            fetch('/sync/status')
                .then(function (res) { return res.json(); })
                .then(function (data) {
                    updateStatusCards(data);

                    if (!data.syncing) {
                        // 同步结束
                        if (pollingTimer) {
                            clearInterval(pollingTimer);
                            pollingTimer = null;
                        }
                        var btn = document.getElementById('btnSync');
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> 立即同步';
                        document.getElementById('syncProgress').classList.remove('active');
                        // 刷新日志
                        loadLogs(1);
                    } else {
                        document.getElementById('syncProgressText').textContent = data.status || '同步中...';
                        document.getElementById('syncProgress').classList.add('active');
                        var btn = document.getElementById('btnSync');
                        btn.disabled = true;
                        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> 同步中...';
                        // 如果没有在轮询，开始轮询
                        if (!pollingTimer) {
                            startPolling();
                        }
                    }
                })
                .catch(function (err) {
                    console.error('获取状态失败:', err);
                });
        }

        // 更新状态卡片
        function updateStatusCards(data) {
            document.getElementById('totalRepos').textContent = data.totalRepos || 0;
            document.getElementById('lastSyncCount').textContent = data.lastSuccessCount || '-';
            document.getElementById('currentStatus').textContent = data.status || '空闲';

            if (data.lastSuccessTime) {
                document.getElementById('lastSyncTime').textContent = formatDateTime(data.lastSuccessTime);
            }
        }

        // 加载同步日志
        function loadLogs(page) {
            currentPage = page;
            fetch('/sync/logs?pageNum=' + page + '&pageSize=' + pageSize)
                .then(function (res) { return res.json(); })
                .then(function (data) {
                    renderLogs(data.records);
                    renderPagination(data.current, data.pages, data.total);
                })
                .catch(function (err) {
                    console.error('加载日志失败:', err);
                });
        }

        // 渲染日志表格
        function renderLogs(records) {
            var tbody = document.getElementById('logTableBody');
            if (!records || records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">暂无同步日志</td></tr>';
                return;
            }

            var html = '';
            for (var i = 0; i < records.length; i++) {
                var log = records[i];
                var statusClass = 'secondary';
                if (log.status === '成功') statusClass = 'success';
                else if (log.status === '失败') statusClass = 'danger';
                else if (log.status === '进行中') statusClass = 'primary';

                html += '<tr>' +
                    '<td><span class="badge bg-info bg-opacity-10 text-info badge-status">' + (log.syncType || '-') + '</span></td>' +
                    '<td><span class="badge bg-' + statusClass + ' bg-opacity-10 text-' + statusClass + ' badge-status">' + (log.status || '-') + '</span></td>' +
                    '<td>' + (log.totalCount != null ? log.totalCount : '-') + '</td>' +
                    '<td>' + (log.syncedCount != null ? log.syncedCount : '-') + '</td>' +
                    '<td>' + formatDateTime(log.startedAt) + '</td>' +
                    '<td>' + formatDateTime(log.finishedAt) + '</td>' +
                    '<td class="text-truncate" style="max-width: 200px;" title="' + (log.errorMessage || '') + '">' +
                    (log.errorMessage || '-') + '</td>' +
                    '</tr>';
            }
            tbody.innerHTML = html;
        }

        // 渲染分页
        function renderPagination(current, totalPages, total) {
            var ul = document.getElementById('paginationUl');
            if (totalPages <= 1) {
                ul.innerHTML = '';
                return;
            }

            var html = '';
            // 上一页
            html += '<li class="page-item ' + (current <= 1 ? 'disabled' : '') + '">' +
                '<a class="page-link" href="javascript:void(0)" onclick="loadLogs(' + (current - 1) + ')">上一页</a></li>';

            // 页码
            var start = Math.max(1, current - 2);
            var end = Math.min(totalPages, current + 2);
            for (var i = start; i <= end; i++) {
                html += '<li class="page-item ' + (i === current ? 'active' : '') + '">' +
                    '<a class="page-link" href="javascript:void(0)" onclick="loadLogs(' + i + ')">' + i + '</a></li>';
            }

            // 下一页
            html += '<li class="page-item ' + (current >= totalPages ? 'disabled' : '') + '">' +
                '<a class="page-link" href="javascript:void(0)" onclick="loadLogs(' + (current + 1) + ')">下一页</a></li>';

            ul.innerHTML = html;
        }

        // 格式化日期时间
        function formatDateTime(dt) {
            if (!dt) return '-';
            if (typeof dt === 'string') {
                return dt.replace('T', ' ').substring(0, 19);
            }
            // 如果是数组格式 [year, month, day, hour, minute, second]
            if (Array.isArray(dt)) {
                var y = dt[0];
                var m = String(dt[1]).padStart(2, '0');
                var d = String(dt[2]).padStart(2, '0');
                var h = dt.length > 3 ? String(dt[3]).padStart(2, '0') : '00';
                var mi = dt.length > 4 ? String(dt[4]).padStart(2, '0') : '00';
                var s = dt.length > 5 ? String(dt[5]).padStart(2, '0') : '00';
                return y + '-' + m + '-' + d + ' ' + h + ':' + mi + ':' + s;
            }
            return String(dt);
        }
    </script>
</th:block>
</body>
</html>
